# 시스템 아키텍처 명세: 스크래치 복권 이벤트 (v3.2 - 전체)

## 1. 아키텍처 개요

본 아키텍처는 **네이티브 앱이 모든 백엔드 통신을 대리(Proxy)하는 보안 강화 모델**입니다. 웹 기술(이벤트 페이지)은 순수하게 UI 표현에만 집중하고, 모든 데이터와 비즈니스 로직은 네이티브 앱과 백엔드 API를 통해서만 처리됩니다.

*   **사용자 프론트엔드 (정적 페이지):** UI 렌더링만을 담당하는 가벼운 정적 페이지입니다. 백엔드와 직접 통신하지 않으며, 오직 네이티브 앱과 **자바스크립트 브릿지(JavaScript Bridge)**를 통해서만 데이터를 주고받습니다.
*   **네이티브 앱 (Android/iOS):** **보안 프록시**이자 **API 클라이언트**의 핵심 역할을 수행합니다. WebView를 제어하며, 이벤트 페이지의 모든 데이터 요청과 액션을 받아 백엔드 API와 통신합니다.
*   **백엔드 (Server API):** 모든 비즈니스 로직을 담당하며, **오직 신뢰된 클라이언트인 네이티브 앱하고만 통신**합니다.
*   **관리자 프론트엔드 (React):** 마케팅 관리자를 위한 관리자용 대시보드입니다.

## 2. 아키텍처 다이어그램

```
+----------------------------------------------------+
|           Native Mobile App (Android/iOS)            |
| +------------------------------------------------+ |
| |  Native Code (모든 API 통신 및 로직 처리)        | |
| +--------------------^---------------------------+ |
|                      |                             |
| (JavaScript Bridge)  | (백엔드 API 호출)           |
| (데이터/액션 교환)   |                             |
|                      |                             |
| +--------------------V---------------------------+ |
| |                  WebView                       | |
| |    +-----------------------------------+     | |
| |    |  Static Event Page (from S3)      |     | |
| |    | (UI 렌더링만 담당)                |     | |
| |    +-----------------------------------+     | |
| +------------------------------------------------+ |
+------------------------|-----------------------------+
                         |
+------------------------V-----------------------------+
|                Backend API Server                  |
|      (오직 네이티브 앱의 요청만 허용)              |
+----------------------------------------------------+
```

## 3. 데이터 흐름 설명 (v3.2 상세 흐름)

**A. 사용자 이벤트 참여 흐름**

1.  **(URL 로드):** 네이티브 앱은 `https://.../index.html?eventId=evt_12345abc` 와 같이 `eventId`가 포함된 URL을 생성하여 웹뷰로 로드합니다.

2.  **(페이지 준비 신호):** 웹 페이지(JavaScript)가 로드되면, URL의 쿼리 파라미터에서 `eventId`를 추출합니다. 그리고 즉시 **JavaScript Bridge**를 통해 네이티브 앱에 `window.nativeApp.onPageReady("evt_12345abc")`를 호출하여 페이지가 준비되었고 어떤 이벤트에 해당하는지 알립니다.

3.  **(데이터 요청):** 네이티브 앱은 `onPageReady`로 전달받은 `eventId`를 사용하여, 백엔드 API(`GET /events/{id}`)를 **직접 호출**하여 이벤트 데이터를 요청합니다.

4.  **(데이터 주입 및 렌더링):** 네이티브 앱은 백엔드로부터 받은 이벤트 데이터를 다시 **JavaScript Bridge**를 통해 웹 페이지의 `initializeEvent(data)` 함수로 전달합니다. 웹 페이지는 이 데이터를 받아 최종 UI를 렌더링합니다.

5.  **(이벤트 참여 알림):** 사용자가 복권을 긁으면, 웹 페이지는 **JavaScript Bridge**를 통해 네이티브 앱에 `window.nativeApp.participateEvent()`를 호출하여 참여 의사를 알립니다.

6.  **(참여 처리 및 결과 반환):** 네이티브 앱은 이 신호를 받아 백엔드 API(`POST /events/{id}/participate`)를 **직접 호출**합니다. 백엔드에서 결과를 받으면, 다시 **JavaScript Bridge**를 통해 웹 페이지의 `showResult(result)` 함수로 전달하여 결과를 화면에 표시합니다.

**B. 관리자 이벤트 관리 흐름**

*   마케팅 관리자는 웹 브라우저에서 Admin Dashboard(React 앱)에 접속하여 백엔드 Admin API를 통해 이벤트를 관리합니다.

## 4. 구성 요소별 역할과 책임 (전체)

*   **Static Event Page (HTML/CSS/JS):**
    *   **역할:** 순수한 UI 렌더링 엔진.
    *   **책임:** 네이티브 앱으로부터 받은 데이터로 UI를 그리고, 사용자 액션이 발생하면 네이티브 앱에 알리는 역할.

*   **AWS S3 (Simple Storage Service):**
    *   **역할:** 정적 웹 호스팅 저장소.
    *   **책임:** 이벤트 페이지(HTML, CSS, JS, 이미지)를 저장하고, 웹을 통해 안정적이고 빠르게 제공.

*   **Native Mobile App (Android/iOS):**
    *   **역할:** **보안 프록시** 및 **API 클라이언트**.
    *   **책임:** 백엔드 API와 통신하는 유일한 클라이언트 역할, WebView와 데이터를 주고받는 JavaScript Bridge 인터페이스 관리.

*   **Android/iOS WebView:**
    *   **역할:** 네이티브 코드와 웹 페이지 간의 통신 채널.
    *   **책임:** S3 URL을 로드하고, 양방향 JavaScript Bridge 통신을 안정적으로 지원.

*   **API Gateway (백엔드 진입점):**
    *   **역할:** 모든 클라이언트 요청의 단일 진입점.
    *   **책임:** 요청 로깅, 트래픽 속도 제한(Rate Limiting), 인증 토큰 검증, 요청을 적절한 내부 서비스로 라우팅.

*   **Event Service (핵심 백엔드):**
    *   **역할:** 이벤트 관련 모든 비즈니스 로직 수행.
    *   **책임:** 사용자 참여 처리, 이벤트 정보 제공, 관리자용 CRUD API 제공, 서버 사이드 당첨 확률 계산 등 핵심 로직 수행.

*   **Authentication Service (인증 백엔드):**
    *   **역할:** 사용자 및 관리자 신원 확인.
    *   **책임:** 로그인 요청 처리 및 인증 토큰(JWT) 발급, 토큰 검증.

*   **Database:**
    *   **역할:** 모든 데이터의 영구 저장소.
    *   **책임:** Events, Prizes, Users, Participation_Logs 등 모든 관련 데이터를 저장하고 관리.

*   **Admin Dashboard (React):**
    *   **역할:** 마케팅 관리자를 위한 이벤트 관리 도구.
    *   **책임:** 백엔드의 Admin API와 통신하여 이벤트 CRUD 및 통계 확인 등 복잡한 관리 기능을 제공.